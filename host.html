<!DOCTYPE HTML>
<html>
  <head>
    <title>Better Call the Exterminator!</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="modal" id="popupBack"><div style="font-size: 50px;cursor:pointer;user-select:none;display:none" onclick="menu()" id="close">&times</div><div id="popup" style="width:2px;height:2px;"></div></div>
    <div class="corkCont"><img src='assets/corkboard.png' height='100%'><div id="hostTime">5:00</div><div id="hostInfo"><h1>What we know</h1>Nothing yet</div></div>
    </body>
    <script src="script.js"></script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { get, update, getDatabase, ref, child, set } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-database.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBWBFJ9yYYDXTgTQieDFfJ5O4uVJ2GMEos",
      authDomain: "better-call-the-exterminator.firebaseapp.com",
      projectId: "better-call-the-exterminator",
      storageBucket: "better-call-the-exterminator.appspot.com",
      messagingSenderId: "786054842141",
      appId: "1:786054842141:web:eaafc978769f9e423b03f4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase();
    var acint;
    function createGame() {
  window.newid = Math.ceil(Math.random() * (20000000 - 10000000) + 10000000)
    get(child(ref(getDatabase()), "gameid/" + newid)).then((snapshot) => {
      if (snapshot.exists()) {createGame()} else {
        update(ref(getDatabase(), 'gameid/' + newid), {
          "source": sourceR
        });
      get(child(ref(getDatabase()), "gameid/" + newid)).then((snapshot) => {
          if (snapshot.exists()) {
            pinShow()
            nameint = setInterval(getNames,500)
          }
      })
      }})
      }
    setTimeout(createGame,400)
    function actionCheck() {
        get(child(ref(getDatabase()), "gameid/" + newid)).then((snapshot) => {
          if (snapshot.exists()) {
            var data = snapshot.val()
            var act = data.action
            if (act) {
              popout(act)
              clearInterval(acint)
              acint = setInterval(removeACheck,500)
            }
          }
        })
      }

      function removeACheck() {
            get(child(ref(getDatabase()), "gameid/" + newid)).then((snapshot) => {
              if (snapshot.exists()) {
                var data = snapshot.val()
                if (!data.action) {
                  popout()
                  clearInterval(acint)
                  acint = setInterval(actionCheck,500)
                }
              }})
          }
          function pinShow() {
            pin.innerHTML = newid
            namesD.innerHTML = "Waiting for players..."
          }

          
    popout(`
      <div style="text-align:center">
        <h1 style='font-size:70px' id='pin'>Loading PIN...</h1>
        <div id='namesD'></div>
        <p><button onclick='startG()' id='sbtn' style='display:none;margin:auto'>Start</button></p>
      </div>
    `)
    var countint;
    function startG() {
        popout()
        clearInterval(nameint)
        countint = setInterval(count,1000)
        update(ref(getDatabase(), 'gameid/' + newid), {"started":true});
        acint = setInterval(actionCheck,500);
      }
    function getNames() {
      get(child(ref(getDatabase()), "gameid/" + newid + "/players")).then((snapshot) => {
              if (snapshot.exists()) {
                var data = snapshot.val()
                var stringdata = "";
                Object.keys(data).forEach(function(k) {
                  stringdata = stringdata + "<div class='name'>" + data[k] + "</div>"
                })
                namesD.innerHTML = stringdata
                sbtn.style.display = "block";
                window.names = [];
                var num = -1
                Object.keys(data).forEach(function(k) {
                  num = num + 1
                  names[num] = data[k]
                })
              }})
    }

    function newround() {
      var src = rooms[sourceR]
      var options = [sourceR,src.room1,src.room2]
      var currentRoom = options[Math.floor(Math.random() * options.length)]
      var name1 = names[Math.floor(Math.random() * names.length)]
      var name2 = names[Math.floor(Math.random() * names.length)]
      var name3 = names[Math.floor(Math.random() * names.length)]
      var name4 = names[Math.floor(Math.random() * names.length)]
      var name5 = names[Math.floor(Math.random() * names.length)]
      update(ref(getDatabase(), 'gameid/' + newid), {
        "currentGuessers": name1 + "," + name2 + "," + name3 + "," + name4 + "," + name5,
        "currentAttackRoom": currentRoom
      });
    }

    function getInfo() {
      get(child(ref(getDatabase()), "gameid/" + newid)).then((snapshot) => {
              if (snapshot.exists()) {
                var data = snapshot.val()
                if (data.clues) {
                  hostInfo.innerHTML = "<h1>What we know</h1>" + data.clues
                }
              }})
    }
    var trMin = 59
    var trHour = 4
    function count() {
      trMin = trMin - 1
      if (trMin == 0) {
        trMin = 60
        trHour = trHour - 1
      }
      if (trMin.toString().length == 1) {
        var minTXT = "0" + trMin
      } else {
         var minTXT = trMin
      }
      if (trHour == 0 && trMin == 1) {
        update(ref(getDatabase(),'gameid/' + newid),{"action":"<img width='50%' src='assets/exterminator.png'><h1>Alright, where are the bugs?</h1>"})
        setTimeout(function() {
          update(ref(getDatabase(),'gameid/' + newid),{"action":null})
          setTimeout(function() { 
            update(ref(getDatabase(),'gameid/' + newid),{"action":"<h1>Vote for the room you think the nest is.</h1>"})
            voteint = setInterval(voteCheck,1000)
          },1000)
        },5000)
        voteint = setInterval(voteCheck,1000)
        clearInterval(countint)
      } else {
        hostTime.innerHTML = trHour + ":" + minTXT
      }
    }
    function endGame(curl) {
        set(ref(getDatabase(), 'gameid/' + newid), {});
        if (curl) {location.replace(curl)} else {location.replace("/")}
      }
    var nameint;
    setInterval(getInfo,1000)
    var voteint;
    function voteCheck() {
      get(child(ref(getDatabase()), "gameid/" + newid + "/votes")).then((snapshot) => {
              if (snapshot.exists()) {
                var data = snapshot.val()
                var sortedJSON = Object.entries(data).sort((a, b) => b[1] - a[1]).reduce((acc, [key, value]) => ({ ...acc, [key]: value }), {});
                var sortedArray = Object.keys(sortedJSON)
                if (sortedArray.length == names.length) {
                  clearInterval(voteint)
                  guess(sortedArray[0])
                }
              }})
    }
    window.voteCheck = voteCheck
    window.count = count
    window.startG = startG
    window.newround = newround
    window.onbeforeunload = function() {set(ref(getDatabase(), 'gameid/' + newid), {})}
  </script>
</html>
