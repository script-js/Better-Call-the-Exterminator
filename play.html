<!DOCTYPE HTML>
<html>
  <head>
    <title>Better Call the Exterminator!</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body> 
    <div class="modal" id="popupBack"><div style="font-size: 50px;cursor:pointer;user-select:none;display:none" onclick="menu()" id="close">&times</div><div id="popup" style="width:2px;height:2px;"></div></div>
    <div id="guessBox"><div class="guessCont"><img onclick="sendChoice(this)" class="guessImg" src="assets/bedbath.jpg" style="width:40%"><br>Ensuite Bathroom</div><div class="guessCont"><img onclick="sendChoice(this)" class="guessImg" src="assets/bed2.jpg"><br>Master Bedroom</div><div class="guessCont"><img onclick="sendChoice(this)" class="guessImg" src="assets/bath.jpg"><br>Bathroom</div><div class="guessCont"><img onclick="sendChoice(this)" class="guessImg" src="assets/bed1.jpg"><br>Second Bedroom</div><div class="guessCont"><img onclick="sendChoice(this)" class="guessImg" src="assets/kitchen.jpg"><br>Kitchen</div><div class="guessCont"><img onclick="sendChoice(this)" class="guessImg" src="assets/living.jpg"><br>Living Room</div><div class="guessCont"><img onclick="sendChoice(this)" class="guessImg" src="assets/family.jpg"><br>Family Room</div></div>
  </body>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { get, update, getDatabase, ref, child } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-database.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBWBFJ9yYYDXTgTQieDFfJ5O4uVJ2GMEos",
      authDomain: "better-call-the-exterminator.firebaseapp.com",
      projectId: "better-call-the-exterminator",
      storageBucket: "better-call-the-exterminator.appspot.com",
      messagingSenderId: "786054842141",
      appId: "1:786054842141:web:eaafc978769f9e423b03f4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase()
    const dbRef = ref(db)

    function actionCheck() {
        get(child(ref(getDatabase()), "gameid/" + gameid)).then((snapshot) => {
          if (snapshot.exists()) {
            var data = snapshot.val()
            var act = data.action
            if (act) {
              if (act == "<h1>Vote for the room you think the nest is.</h1>") {
                setTimeout(function() {
                  changeBF(function() {sendVote(this)})
                  popout()
                },2000)
              }
              popout(act)
              clearInterval(acint)
              acint = setInterval(removeACheck,500)
            }
          }
        })
      }

      function removeACheck() {
            get(child(ref(getDatabase()), "gameid/" + gameid)).then((snapshot) => {
              if (snapshot.exists()) {
                var data = snapshot.val()
                if (!data.action) {
                  popout()
                  clearInterval(acint)
                  acint = setInterval(actionCheck,500)
                }
              }})
          }
    function sync() {
      get(child(ref(getDatabase()), "gameid/" + gameid)).then((snapshot) => {
              if (snapshot.exists()) {
                var data = snapshot.val()
                sourceR = data.source
                var toadd = {}
                toadd["/gameid/" + gameid + "/players/" + playerID] = uid;
                update(dbRef,toadd)
                acint = setInterval(actionCheck,500)
              } else {
                popout("<div style='text-align:center'><h1>Game ID Inactive</h1><a href='/'><button>Go Back</button></a></div>")
              }
      })
    }
    
    var acint;
    if (sessionStorage.getItem("gameid") && localStorage.getItem("username")) {
      window.gameid = sessionStorage.getItem("gameid")
      var playerID = btoa(Math.random())
      window.uid = localStorage.getItem("username")
      sync()
    } else {
      popout("<div style='text-align:center'><h1>Something went wrong!</h1><a href='join'><button>Go Back</button></a></div>")
    }

    function changeBF(func) {
      var choices = guessBox.querySelector(".guessImg")
      Object.keys(choices).forEach(function(k) {
        choices[k].onclick = func
      })
    }

    function sendVote(elem) {
      var choice = elem.src.replace("assets/","").replace(".jpg","")
      get(child(dbRef, "/gameid/" + gameid + "/votes")).then((snapshot) => {
        var toadd = {};
        if (snapshot.exists()) {
          var gdata = snapshot.val();
          if (gdata[urlId]) {
            toadd[choice] = gdata[choice] + 1;
          } else {
            toadd[choice] = 1;
          }
        } else {
          toadd[choice] = 1;
        };
        update(ref(db,"/gameid/" + gameid + "/votes"),toadd)
      });
    }
  </script>
  <script src="script.js"></script>
</html>
